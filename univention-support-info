#!/usr/bin/env python
# -*- coding: utf-8 -*-
#
# univention-support-info - collect system information
#
# Copyright 2011 Univention GmbH
#
# http://www.univention.de/
#
# All rights reserved.
#
# The source code of this program is made available
# under the terms of the GNU Affero General Public License version 3
# (GNU AGPL V3) as published by the Free Software Foundation.
#
# Binary versions of this program provided by Univention to you as
# well as other copyrighted, protected or trademarked materials like
# Logos, graphics, fonts, specific documentations and configurations,
# cryptographic keys etc. are subject to a license agreement between
# you and Univention and not subject to the GNU AGPL V3.
#
# In the case you use this program under the terms of the GNU AGPL V3,
# the program is provided in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public
# License with the Debian GNU/Linux or Univention distribution in file
# /usr/share/common-licenses/AGPL-3; if not, see
# <http://www.gnu.org/licenses/>.
usiVersion = '58'

fingerprint = '1EB89EEB365A84A65F95FB28CD78CD3C8F91B44F'
# create with: gpg2 --armor --export --export-options export-minimal $fingerprint
keyData = '\n'.join((
	'-----BEGIN PGP PUBLIC KEY BLOCK-----',
	'Version: GnuPG v2.0.22 (GNU/Linux)',
	'',
	'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',
	'QMqAz4w8ICKwa7g2OyHDPc3gelXuryP7zPMYVI2hwubg64vHiV/aGVULBWonolRx',
	'lpL39xpuQI/pOJyAAY1QfdPfUiuxOkLyEmvEVxUABonTcuW0K1BhcnRuZXItTGlz',
	'dHMgPHBhcnRuZXItbGlzdHNAdW5pdmVudGlvbi5kZT6JAlQEEwEIAD4WIQQeuJ7r',
	'NlqEpl+V+yjNeM08j5G0TwUCWE/bZQIbAwUJA9ofEAULCQgHAgYVCAkKCwIEFgID',
	'AQIeAQIXgAAKCRDNeM08j5G0T5G7EACV9mXxx7eIqxYOf/h61MrjEIl2shwqEO2H',
	'lgiX2nPBEcY7gy9r7YPZRvEkdnnXTMzlMS3BPoV6oMsS1BZqwLvEpf2I578UKGZA',
	'cIqjFC5VXzfyDGJDXAl+ZzH3o14Z87VpCJvcTSXcKxzyDZdbFPBZ7xdjfDVy1RsW',
	'tpCY98Bk7eRcWWCF8czgmlX+bsL4T88poT8pVq8A+1pDPGwYWzp1z6NO/ipPA4Ep',
	'y2v6geJDVExcQzYYu+GvIyR6eHzrsExlmqo0fr4QYr1WuJuJQ98VfhMGyD76ihkz',
	'StltLiqHfablMv+MIdaM5tGqL9Q7qbqkDTsh5yEyydwqpaknh3pD3pcqIzqYlk46',
	'AOgrDCYWaogg1wf89L5jbGXxAmBoTptL3R69BZ+ML+vwl8Ws52fsHbRQDJac2Qcj',
	'XAImB6VAmZ0iprAVWyGRmuZd5bi1MEkIPyUetUvnl7tBzzi2nS+nbLC9oFoL5ORu',
	'DliJfX/qrM0wN70qNmW90LC13b9yNckTxxJ+0idpMwtw827AZjVauv6INyZHsr0w',
	'nWCyX0j8i2H3yXDAHeXp6aNui4l1Pg6xcghL1SYcffDHX8Pkqw9tpeNN9toP2RWB',
	'IjiHsndE0F8DW836ux5Fp3cetcWSOJRcL7rBjBDK7PeAYWbCZW0pO48QRB83OGPd',
	'vU745ECeNrQsVW5pdmVudGlvbiBGZWVkYmFjayA8ZmVlZGJhY2tAdW5pdmVudGlv',
	'bi5kZT6JAlQEEwEIAD4WIQQeuJ7rNlqEpl+V+yjNeM08j5G0TwUCWE/bcgIbAwUJ',
	'A9ofEAULCQgHAgYVCAkKCwIEFgIDAQIeAQIXgAAKCRDNeM08j5G0T5UKEADV2zj4',
	'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',
	'AlSaHSd04jsZmCYZJ/Pmw+ir5klCuGbUs+Jedec=',
	'=1V77',
	'-----END PGP PUBLIC KEY BLOCK-----'))
toprc = '\n'.join(('RCfile for "top with windows"		   # shameless braggin\'',
				   'Id:a, Mode_altscr=0, Mode_irixps=1, Delay_time=3.000, Curwin=0',
				   'Def	 fieldscur=AEHIOQTWKNMbcdfgjplrsuvyzX',
				   '		winflags=62905, sortindx=10, maxtasks=0',
				   '		summclr=1, msgsclr=1, headclr=3, taskclr=1',
				   'Job	 fieldscur=ABcefgjlrstuvyzMKNHIWOPQDX',
				   '		winflags=62777, sortindx=0, maxtasks=0',
				   '		summclr=6, msgsclr=6, headclr=7, taskclr=6',
				   'Mem	 fieldscur=ANOPQRSTUVbcdefgjlmyzWHIKX',
				   '		winflags=62777, sortindx=13, maxtasks=0',
				   '		summclr=5, msgsclr=5, headclr=4, taskclr=5',
				   'Usr	 fieldscur=ABDECGfhijlopqrstuvyzMKNWX',
				   '		winflags=62777, sortindx=4, maxtasks=0',
				   '		summclr=3, msgsclr=3, headclr=2, taskclr=3',
				   '',
				   ))

import cStringIO
import glob
import re
import gzip
import optparse
import os
import shutil
import socket
import stat
import subprocess
import threading
import sys
import tarfile
import tempfile
import time
import urllib2
from distutils.spawn import find_executable

# ignore apt's "API not stable yet" warning
import warnings
warnings.filterwarnings("ignore", category=FutureWarning, append=True)

import apt
import apt_pkg

try:
	from univention import config_registry
except ImportError:
	if os.path.isfile('/usr/share/pyshared/univention/config_registry.py'):
		import imp
		config_registry = imp.load_source('config_registry', '/usr/share/pyshared/univention/config_registry.py')
	else:
		sys.path.append('/usr/share/pyshared')
		from univention import config_registry

ucr = config_registry.ConfigRegistry()
ucr.load()
timeString = time.strftime('%Y-%m-%d_%H-%M-%SZ', time.gmtime())
hostname = socket.gethostname()


class Command(object):
	def __init__(self, cmd, Input):
		self.cmd = cmd
		self.Input = Input
		self.process = None
		self.outData = ""
		self.errData = ""

	def run(self, timeout):
		def target():
			try:
				self.process = subprocess.Popen(self.cmd, stdin=subprocess.PIPE, stdout=subprocess.PIPE, stderr=subprocess.PIPE, close_fds=True, env=env)
				(self.outData, self.errData) = self.process.communicate(input=self.Input)
			except (OSError, IOError) as ex:
				self.outData="Could not execute %s: %s" % (repr(self.cmd), repr(' '.join(map(str, ex.args))))

		thread = threading.Thread(target=target)
		thread.start()

		thread.join(timeout)
		if thread.is_alive():
			self.process.terminate()
			thread.join()
		if self.process:
			return (self.process.returncode, self.outData, self.errData)
		else:
			return (1, self.outData, self.errData)


def Popen(CommandTuple, Input=None, timeout=30):
	command = Command(CommandTuple, Input)
	Result = command.run(timeout)
	if Result[0] != 0:
		print >> usilog, "Command: '%s'\nResult: '%s'" % (repr(CommandTuple), repr(Result))
		if Result[0] == -15:
			print >> usilog, "Process has been terminated [timeout]"
		print >> usilog, ""
	return Result


def _ldapsearchCommand():
	''' Get ldapsearch command depending on UCS version '''
	if find_executable('univention-ldapsearch'):
		return 'univention-ldapsearch'
	return 'ldapsearch'


def _sprint(string):
	''' write status string to stdout without newline '''
	sys.stdout.write(string)
	sys.stdout.flush()


def U32(i):
	'''
	Return i as an unsigned integer, assuming it fits in 32 bits.
	If it's >= 2GB when viewed as a 32-bit unsigned int, return a long.
	'''
	if i < 0:
		i += 1L << 32
	return i


def addFile(name, size, fileobj):
	# try to determine filesize
	if size is None or size is False:
		fileobj.seek(0, os.SEEK_END)
		size = fileobj.tell()
	if fileobj.tell() > 0:
		fileobj.seek(0)

	info = tarfile.TarInfo()
	info.size = size
	info.name = 'univention-support-info-' + hostname + '-' + timeString + '/' + name
	info.mode = stat.S_IRUSR
	info.mtime = time.time()
	try:
		archive.addfile(info, fileobj)
	except IOError, ex:
		print 'WARNING: failed to add %r: error=%r' % (fileobj, ex)


def addFileByPath(filename, flat):
	if filename.startswith('/proc/'):
		# This is a /proc/ file, os.stat(filename).st_size will always return 0
		tmpf = tempfile.mkstemp(prefix='univention-support-info.')[1]
		try:
			shutil.copy(filename, tmpf)
		except (OSError, IOError), error:
			error = '\n'.join(map(str, error.args))
			if flat:
				addFile('files/' + filename.strip('/').replace('/', '_') + '.ERROR', len(error), cStringIO.StringIO(error))
			else:
				addFile('files/' + filename.strip('/') + '.ERROR', len(error), cStringIO.StringIO(error))
			os.unlink(tmpf)
		filesize = os.stat(tmpf).st_size
		os.unlink(tmpf)
	else:
		try:
			filesize = os.stat(filename).st_size
		except (OSError, IOError), error:
			filesize = 0

	try:
		fileobj = open(filename, 'rb')
	except (OSError, IOError), error:
		error = '\n'.join(map(str, error.args))
		if flat:
			addFile('files/' + filename.strip('/').replace('/', '_') + '.ERROR', len(error), cStringIO.StringIO(error))
		else:
			addFile('files/' + filename.strip('/') + '.ERROR', len(error), cStringIO.StringIO(error))
	else:
		# addFile('files/' + filename.strip('/').replace('/', '_'), filesize, fileobj)
		addFile('files/' + filename.strip('/'), filesize, fileobj)
		fileobj.close()


def certificateValidity(CertificatePath, flat):
	try:
		import M2Crypto
	except ImportError, error:
		error = '\n'.join(map(str, error.args))
		if flat:
			addFile('info/ssl/' + CertificatePath.strip('/').replace('/', '_') + '.ERROR', len(error), cStringIO.StringIO(error))
		else:
			addFile('info/ssl/' + CertificatePath.strip('/') + '.ERROR', len(error), cStringIO.StringIO(error))
		return

	try:
		cert = M2Crypto.X509.load_cert(CertificatePath)
		validity = '%s\nNot Before: %s\nNot After : %s\n' % (CertificatePath, cert.get_not_before(), cert.get_not_after(), )
		if flat:
			addFile('info/ssl/' + CertificatePath.strip('/').replace('/', '_'), len(validity), cStringIO.StringIO(validity))
		else:
			addFile('info/ssl/' + CertificatePath.strip('/'), len(validity), cStringIO.StringIO(validity))
	except (OSError, IOError, M2Crypto.X509.X509Error), error:
		error = '\n'.join(map(str, error.args))
		if flat:
			addFile('info/ssl/' + CertificatePath.strip('/').replace('/', '_') + '.ERROR', len(error), cStringIO.StringIO(error))
		else:
			addFile('info/ssl/' + CertificatePath.strip('/') + '.ERROR', len(error), cStringIO.StringIO(error))


def certificateValidities(flat):
	_sprint('Checking certificate validity: ')
	CertificatePatterns = [
		'/etc/univention/ssl/*.*/cert.pem',
		'/etc/univention/ssl/ucsCA/CAcert.pem',
		]
	for CertificatePattern in CertificatePatterns:
		for CertificatePath in glob.glob(CertificatePattern):
			certificateValidity(CertificatePath, flat)
	print 'done.'


def simpleFiles(flat):
	# add S4-Connector Mapping (BUG 40571)
	# add shares.conf.d/*
	# /boot/config-*, /etc/crontab, /var/spool/cron/**, removed and add /proc/modules (BUG 35075)
	FilePatterns = [
		'/etc/apache2/*',
		'/etc/apache2/*/*',
		'/etc/apt/*',
		'/etc/apt/*/*',
		'/etc/cron*/*',
		'/etc/crontab',
		'/etc/fstab',
		'/etc/imapd/*',
		'/etc/mtab',
		'/etc/passwd',
		'/etc/procmailrc',
		'/etc/spamassassin/*',
		'/etc/univention/connector/ad/mapping.py',
		'/etc/univention/connector/s4/mapping',
		'/etc/univention/connector/s4/mapping.py',
		'/etc/univention/connector/s4/mapping',
		'/etc/univention/installation_profile',
		'/etc/ox-secrets/*',
		'/opt/open-xchange/etc/*',
		'/opt/open-xchange/etc/*/*',
		'/opt/open-xchange/etc/*/*/*',
		'/proc/mounts*',
		'/proc/mdstat',
		'/proc/modules',
		'/proc/drbd',
		'/proc/cmdline',
		'/var/lib/univention-directory-listener/bad_cache',
		'/var/lib/univention-directory-replication/failed.ldif',
		'/var/lib/univention-connector/s4/*',
		'/var/lib/samba/private/.adtakeover/*',
		'/var/spool/cron/**',
		'/etc/postfix/*',
		'/etc/samba/shares.conf.d/*',
		'/etc/imapd/*',
		'/var/univention-backup/ad-takeover/*',
		'/etc/*/local.conf*',
		'/root/.bash_history',
		'/etc/ldap/slapd.conf',
		]
	FileExcludePatterns = ['/etc/apache2/mods-available/*', '/etc/apache2/sites-available/*']

	Files = set()
	ExcludeFiles = list()
	for FileExcludePattern in FileExcludePatterns:
		ExcludeFiles.extend(glob.glob(FileExcludePattern))
	for FilePattern in FilePatterns:
		for Filename in glob.glob(FilePattern):
			if Filename not in ExcludeFiles:
				Files.add(Filename)

	_sprint('Collecting files: ')
	for Filename in sorted(list(Files)):
		if os.path.isfile(Filename):
			addFileByPath(Filename, flat)
			_sprint('.')
	print 'done.'


def licenseObject():
	''' Get license object from ldap (cn=license) '''
	stdout = executeCommand('univention-license-object', (_ldapsearchCommand(), '-x', '-b', 'cn=license,cn=univention,'+ucr.get('ldap/base')))
	addFile('info/univention-license-object', len(stdout), cStringIO.StringIO(stdout))


def checkMaintenance():
	''' Check if UCS-Version is in maintenance '''
	if ucr.get('server/role') != 'ucc':
		ucs_ver = ucr.get('version/version') + '-' + ucr.get('version/patchlevel')
		ucs_lic = ucr.get('license/base')
		# TODO: check depending on License
		try:
			maint_url = "http://updates.software-univention.de/download/ucs-maintenance/" + ucs_ver + ".yaml"
			data = urllib2.urlopen(maint_url).read()
			maint_info = dict((k.strip(), v.strip()) for k, v in (line.split(':', 1) for line in data.split("\n") if line))
			# if maint_info['extended'].lower() not in ['true', '1']:
			if maint_info['maintained'].lower() not in ['true', '1']:
				tmpf = tempfile.TemporaryFile(prefix='univention-support-info.')
				print "\033[93mPlease note, system is no longer maintained, security updates are no longer available for current UCS Version %s\033[0m" % (ucs_ver)
				print >> tmpf, "Please note, system is no longer maintained, security updates are no longer available for current UCS Version %s" % (ucs_ver)
				addFile('info/maintenance', None, tmpf)
			else:
				tmpf = tempfile.TemporaryFile(prefix='univention-support-info.')
				print >> tmpf, "maintenance ok\ncurrent UCS Version %s" % (ucs_ver)
				addFile('info/maintenance', None, tmpf)
		except (urllib2.URLError, IOError) as innerex:
			tmpf = tempfile.TemporaryFile(prefix='univention-support-info.')
			print "Warn: Can't reach univention server - product maintenance undetermined [%s]" % (innerex)
			print >> tmpf, "Failed to check maintenance (%s)\ncurrent UCS Version %s" % (innerex, ucs_ver)
			addFile('info/maintenance', None, tmpf)
	else:
		ucc_ver = ucr.get('version/version')
		tmpf = tempfile.TemporaryFile(prefix='univention-support-info.')
		print "Could NOT determine product maintenance for UCC systems."
		print >> tmpf, "Could NOT determine product maintenance for UCC systems.)\ncurrent UCC Version %s" % (ucc_ver)
		addFile('info/maintenance', None, tmpf)


def checkEntryUUID():
	''' Check if ldap base is searchable by its entryUUID '''
	entryuuid = ""
	basedn = ""
	tmpf = tempfile.TemporaryFile(prefix='univention-support-info.')
	(exitcode, stdout, stderr, ) = Popen( (_ldapsearchCommand(), '-xLLL', '-sbase', 'entryUUID', ) )
	if exitcode == 0:
		entryuuid = stdout.split()[3]
	else:
		print >> tmpf, "ERROR: ldapsearch for base failed: %s" % str(stderr)
		addFile('info/entryUUID.stderr', None, tmpf)
		return
	(exitcode, stdout, stderr, ) = Popen( (_ldapsearchCommand(), '-xLLL', 'entryUUID='+entryuuid, 'dn', ) )
	if exitcode == 0:
		basedn = stdout.split()[1]
	else:
		print >> tmpf, "ERROR: ldapsearch by entryUUID failed: %s" % str(stderr)
		addFile('info/entryUUID.stderr', None, tmpf)
		return
	if ucr.get('ldap/base') == basedn:
		print >> tmpf, "OK: ldap base found by entryUUID"
	else:
		print >> tmpf, "ERROR: ldap base not found by entryUUID, check ldap index"
	addFile('info/entryUUID', None, tmpf)


def aptPackageList():
	"""List installed packages and their source repository."""
	_sprint('Collecting package lists: ')
	cache = apt.Cache()

	packagesAll = tempfile.TemporaryFile(prefix='univention-support-info.')
	packagesUnknownSource = tempfile.TemporaryFile(prefix='univention-support-info.')

	packages = [_ for _ in cache if _.is_installed]
	for pkg in packages:
		version = pkg.installed.version
		package = pkg.versions[version]
		try:
			uri = package.uri
		except StopIteration:
			print >> packagesUnknownSource, "%s\tUNKNOWN" % (pkg.name,)
			continue
		print >> packagesAll, "%s\t%s" % (pkg.name, uri)

	addFile('info/packages_all', None, packagesAll)
	addFile('info/packages_unknown-source', None, packagesUnknownSource)
	print 'done.'


def executeCommand(commandName, command, log_stderr=False):
	(exitcode, stdout, stderr, ) = Popen(command)
	if exitcode or log_stderr:
		if type(exitcode) is int:
			stderr += '\nExitcode was %d\n' % exitcode
		else:
			stderr += exitcode + '\n'
		addFile('info/' + commandName + '.stderr', len(stderr), cStringIO.StringIO(stderr))
	return stdout


def templateFiles(flat):
	_sprint('Searching for changed template files: ')
	stdout = executeCommand('check-templates', ('find', '/etc/univention/templates/files/', '(', '-name', '*.dpkg-new', '-o', '-name', '*.dpkg-dist', ')', '-print0', ))
	files = [templatefile for templatefile in stdout.split('\0') if templatefile]
	message = ('Found %d:\n' % len(files)) + '\n'.join(files) + '\n'
	addFile('info/check-templates', len(message), cStringIO.StringIO(message))
	for templatefile in files:
		addFileByPath(templatefile, flat)
		if templatefile.endswith('.dpkg-new'):
			addFileByPath(templatefile[:-len('.dpkg-new')], flat)
		elif templatefile.endswith('.dpkg-dist'):
			addFileByPath(templatefile[:-len('.dpkg-dist')], flat)
		_sprint('.')
	print 'done.'


def checkTransactionFile():
	_sprint('Collecting output transaction-file-check: ')

	transactionCheck = tempfile.TemporaryFile(prefix='univention-support-info.')
	try:
		with open('/var/lib/univention-ldap/notify/transaction', 'r') as transaction:
			tac = 1  # transaction id counter
			tlc = 1  # transaction line counter

			for line in transaction:
				tid = line.strip().split(' ', 1)[0]

				try:
					tid = int(tid)
				except:
					print >> transactionCheck, 'ERROR at line %d: "%s"' % (tlc, ' '.join(line))
					continue

				if tid == tac:  # ok
					tac += 1
				else:
					print >> transactionCheck, 'Line %s: \t ID:%s should be %s' % (tlc, tid, tac),
					cld = (tid - tac)  # counter line diff
					if cld < 0:  # id repeat
						cld = (cld * -1)
						print >> transactionCheck, ' REPEATED (%s)' % (cld)
						tac = (tid + cld)
					elif cld > 0:  # id skip
						print >> transactionCheck, ' SKIPPED (%s)' % (cld)
						tac = (tid + 1)

				tlc += 1
		addFile('info/transaction-file-check', None, transactionCheck)
		print 'done.'

	except IOError:
		print >> transactionCheck, 'ERROR: NO TRANSACTION FILE!'
		print 'FAIL'



def collectCommandData():
	# add pvdisplay,vgdisplay,lvdisplay (BUG 35075)
	# add sharesec --view-all (BUG 44376)
	commands = {'hostname-f':
					('hostname', '--fqdn', ),
				'ifconfig-a':
					('ifconfig', '-v', '-a', ),
				'iptables-L_filter':
					('iptables', '-L', '-n', '-v', '-t', 'filter', ),
				'iptables-L_nat':
					('iptables', '-L', '-n', '-v', '-t', 'nat', ),
				'iptables-L_mangle':
					('iptables', '-L', '-n', '-v', '-t', 'mangle', ),
				'iptables-L_raw':
					('iptables', '-L', '-n', '-v', '-t', 'raw', ),
				'iptables-save':
					('iptables-save', '-c', ),
				'route-4':
					('route', '-v', '-ee', '-n', '-A', 'inet', ),
				'route-6':
					('route', '-v', '-ee', '-n', '-A', 'inet6', ),
				'netstat':
					('netstat', '--tcp', '--udp', '--listening', '--program', '--extend', '--extend', '--verbose', '--timers', '--numeric', '--wide', ),
				'dpkg-l':
					('dpkg-query', '--show', '--showformat=${Status}\t${Package}\t${Version}\n', ),
				'dpkg--audit':
					('dpkg', '--audit', ),
				'uname':
					('uname', '-a', ),
				'ps':
					('ps', '-AHFly', ),
				'ps-full':
					('ps', '-ALwwo', 'stat,pid,ppid,sid,tty,nlwp,lwp,pri,ni,sched,wchan,vsz,rss,sz,pcpu,pmem,cmd,blocked,caught,ignored,pending,lstart,cls,time,flags,uid,user,ruid,ruser,suid,suser,gid,group,rgid,rgroup,sgid,sgroup', ),
				'ucr-dump':
					('univention-config-registry', 'dump', ),
				'df-full':
					('df', '--portability', '--print-type', ),
				'df-i-full':
					('df', '--portability', '--print-type', '--inodes', ),
				'df':
					('df', '-h', ),
				'df-i':
					('df', '-h', '-i', ),
				'join-status':
					('univention-check-join-status', ),
				'virsh-qemu':
					('virsh', '-c', 'qemu:///system', 'capabilities', ),
				'virsh-xen':
					('virsh', '-c', 'xen:///',		'capabilities', ),
                                'pvdisplay':
                                        ('pvdisplay',),
                                'vgdisplay':
                                        ('vgdisplay',),
                                'lvdisplay':
                                        ('lvdisplay',),
				'top':
					('top', '-b', '-n2', ),
				'testparm':
					(('testparm', '-s', '-vvv', ), True),
				'listenerID':
					('cat', '/var/lib/univention-directory-listener/notifier_id', ),
				'notifierID':
					('/usr/share/univention-directory-listener/get_notifier_id.py', ),
				'mailq':
					('mailq', ),
				'univention-license-check':
					('univention-license-check', ),
				'hostaccount-id':
					('id', ucr.get('hostname') + '$', ),
				'dig_AXFR':
					('dig', '@%s' % ucr.get('nameserver1'), ucr.get('domainname'), '-t', 'AXFR'),
				'univention-connector-list-rejected':
					('univention-connector-list-rejected', ),
				'sharesec':
					('sharesec', '--view-all', ),
				'adtakeover':
					('ls -1d', '/var/lib/samba*/private.before-ad-takeover-*', ),
				'univentionService':
					('univention-ldapsearch', '-xLLL', '(|(univentionService=S4-Connector)(univentionService=Samba 4))', 'univentionService', ),
					# ('univention-ldapsearch', '-xLLL', '(|(univentionService=S4-Connector)(univentionService=Samba 4))', 'univentionService univentionObjectType univentionServerRole univentionOperatingSystem univentionOperatingSystemVersion', ),
				}
	# Commands depending on samba version
	if sambaDomainVersion == 3:
		commands.update({'test-join':
							('net', 'rpc', 'testjoin', ),
						})
	elif sambaDomainVersion == 4:
		commands.update({'net-ads-info':
							('net', 'ads', 'info', ),
						'net-ads-lookup':
							('net', 'ads', 'lookup', ),
						})
		if ucr.get('samba4/role', None):
			# Run only S4
			commands.update({'samba-tool-drs-showrepl':
								('samba-tool', 'drs', 'showrepl', ),
							'samba-tool-domain-level-show':
								('samba-tool', 'domain', 'level', 'show'),
							'samba-tool-domain-passwordsettings':
								('samba-tool', 'domain', 'passwordsettings', 'show' ),
							'testparm-samba4':
								(('testparm.samba4', '-s', '-vvv'), True),
							'samba-tool-fsmo-show':
								('samba-tool', 'fsmo', 'show'),
							'univention-s4connector-list-rejected':
								('univention-s4connector-list-rejected', ),
							'samba-tool-processes':
								('samba-tool', 'processes'),
							'check-essential-dns-records':
								('/usr/share/univention-samba4/scripts/check_essential_samba4_dns_records.sh',),
							})
			# >= Samba4 RC (UCS 3.1)
			if ucr.get('version/version') >= '3.1':
				commands.update({'samba-tool-domain-info':
									('samba-tool', 'domain', 'info', '127.0.0.1', ),
								})
		else:
			# Run only on S3 member in S4 domain
			commands.update({'test-join':
								('net', 'ads', 'testjoin', ),
							})
	# Commands depending on UCS-Version >= UCS 4.1-3
	if ((ucr.get ('version/version') == '4.1') and (ucr.get ('version/patchlevel') >= '3')) or ucr.get ('version/version') >= '4.2':
		commands.update({'univention-directory-listener-ctrl':
					('univention-directory-listener-ctrl', 'status', ),
					})
	# Commands depending on UCS-Version → UCS 4.2
	if ucr.get ('version/version') >= '4.2':
		commands.update({'journalctl':
							('journalctl', '--since=yesterday', ),
						'hostnamectl-status':
							('hostnamectl', 'status', ),
						'univention-app-info':
							('univention-app', 'info', ),
						})

	_sprint('Collecting command output: ')
	for commandName in commands:
		command = commands[commandName]
		if type(command[0]) == tuple:
			stdout = executeCommand(commandName, command[0], command[1])
		else:
			stdout = executeCommand(commandName, command)

		addFile('info/' + commandName, len(stdout), cStringIO.StringIO(stdout))
		_sprint('.')
	print 'done.'



def univentionSystemInfo():
	_sprint('Collecting hardware information: ')
	manu = executeCommand('dmidecode', ('dmidecode', '-s', 'system-manufacturer'))
	product = executeCommand('dmidecode', ('dmidecode', '-s', 'system-product-name'))
	if not manu:
		manu = 'Unknown'
	if not product:
		product = 'Unknown'
	stdout = executeCommand('univention-system-info', ('univention-system-info', '-u', '-m', manu, '-t', product, '-c', 'Created by univention-support-info', '-s', '-', ))
	archive = None
	for line in stdout.split('\n'):
		if line.startswith('archive'):
			archive = line.split(':', 1)[1]
	if not archive:
		error = 'No archive returned!'
		error += '\nunivention-system-info stdout:\n%s' % stdout
		addFile('info/univention-system-info.ERROR', len(error), cStringIO.StringIO(error))
		return
	filename = os.path.join('/var/www/univention-management-console/system-info/', archive)
	# If UMC is not installed /var/www/univention-management-console/system-info/ does not exist and archive stays in /tmp
	if not os.path.isfile(filename):
		filename = os.path.join('/tmp/', archive)
	try:
		archive = tarfile.open(name=filename, mode='r:*')
		for member in archive:
			if member.isfile():
				fileobj = archive.extractfile(member)
				addFile('info/univention-system-info/' + member.name, member.size, fileobj)
				fileobj.close()
		archive.close()
	except (IOError, tarfile.TarError, ), error:
		error = '\n'.join(map(str, error.args))
		error += '\nunivention-system-info stdout:\n%s' % stdout
		addFile('info/univention-system-info.ERROR', len(error), cStringIO.StringIO(error))
	print 'done.'


def rotatedLogs(regEx, DefaultMaxLineCount, options):
	DirectoryList = [
		('/var/log/auth.log', DefaultMaxLineCount),
		('/var/log/boot.log', DefaultMaxLineCount),
		('/var/log/daemon.log', DefaultMaxLineCount),
		('/var/log/debug.log', DefaultMaxLineCount),
		('/var/log/dpkg.log', DefaultMaxLineCount),
		('/var/log/heimdal-kdc.log', DefaultMaxLineCount),
		('/var/log/kern.log', DefaultMaxLineCount),
		('/var/log/mail.log', DefaultMaxLineCount),
		('/var/log/messages', DefaultMaxLineCount),
		('/var/log/syslog', 2000000),
		('/var/log/apt/term.log', DefaultMaxLineCount),
		('/var/log/univention/connector-s4.log', 2000000),
		('/var/log/univention/system-stats.log', 5000000),
		('/var/log/apache/', DefaultMaxLineCount),
		('/var/log/apache2/', DefaultMaxLineCount),
		('/var/log/cups/', DefaultMaxLineCount),
		('/var/log/dansguardian/', DefaultMaxLineCount),
		('/var/log/freeradius/', DefaultMaxLineCount),
		('/var/log/installer/', 2000000),
		('/var/log/kopano/', 100000),
		('/var/log/libvirt/', DefaultMaxLineCount),
		('/var/log/open-xchange/', DefaultMaxLineCount),
		('/var/log/samba/', DefaultMaxLineCount),
		('/var/log/squid/', DefaultMaxLineCount),
		('/var/log/squidguard/', DefaultMaxLineCount),
		('/var/log/univention/', DefaultMaxLineCount),
		('/var/log/univention/ucc-clients/', DefaultMaxLineCount),
		('/var/log/zarafa/', 100000),
		]
	FullLogs = set((  # for these every available log-file shall be included
		'/var/log/daemon.log',
		'/var/log/dpkg.log',
		'/var/log/kern.log',
		'/var/log/apt/term.log',
		'/var/log/univention/updater.log',
		'/var/log/univention/ad-takeover.log',
	))
	GzipSuffix = '.gz'
	logs = {}
	for Entry in [fp[0] for fp in DirectoryList]:
		if os.path.isdir(Entry):
			FileList = ["%s%s" % (Entry, f, ) for f in os.listdir(Entry) if re.search(r"%s%s" % (os.path.splitext(f)[0], regEx), f)]
		elif os.path.isfile(Entry):
			entryPath = "%s/" % os.path.dirname(Entry)
			entryFile = os.path.basename(Entry)
			entryFilename = os.path.splitext(entryFile)[0]
			FileList = ["%s%s" % (entryPath, f, ) for f in os.listdir(entryPath) if re.search(r"%s%s" % (entryFilename, regEx), f)]
		else:
			FileList = []
		# for filename in glob.glob(FilePattern):
		for filename in FileList:
			if os.stat(filename).st_size <= 0 or os.path.isdir(filename):
				# ignore 0 byte files
				continue
			if filename.endswith(GzipSuffix):
				gzipped = True
				filename = filename[:-len(GzipSuffix)]
			else:
				gzipped = False
			if not filename.endswith('.') and os.path.splitext(filename)[1].strip('0123456789') == '.':  # has extension and only digits in it
				(filename, ext, ) = os.path.splitext(filename)
				number = int(ext.lstrip('.'))
			else:
				number = -1
			if filename not in logs:
				logs[filename] = {}
			logs[filename][number] = gzipped

	_sprint('Collecting logfiles: ')
	for logname in sorted(logs):
		logLinecount = 0
		nonemptyNumber = 0
		for number in sorted(logs[logname]):
			# is logname gzipped?
			gzipped = logs[logname][number]
			path = logname
			fileLinecount = 0
			if number != -1:
				path += '.%d' % number
			if gzipped:
				try:
					logfile = open(path + GzipSuffix, 'rb')
				except (OSError, IOError, ), error:
					error = '\n'.join(map(str, error.args))
					if options.flatStruct:
						addFile('files/' + '%s_%d.stderr' % (logname.strip('/').replace('/', '_'), number, ), len(error), cStringIO.StringIO(error))
					else:
						addFile('files/' + '%s_%d.stderr' % (logname.strip('/'), number, ), len(error), cStringIO.StringIO(error))
					continue

				# calc bytes and linecount of logfile
				# last 4 bytes of a gzip file contain the size of the original (uncompressed) input data modulo 2^32.
				try:
					logfile.seek(-4, os.SEEK_END)
				except IOError, e:
					print('\n\nFilename: %s' % path + GzipSuffix)
					raise IOError(e)
				fileBytes = U32(gzip.read32(logfile))
				logfile.close()
				fileLinecount = int(subprocess.Popen('zcat -f %s | wc -l' % (path + GzipSuffix), stdout=subprocess.PIPE, shell=True).stdout.read().strip())
			else:
				# addFile may calculate the size for us
				fileBytes = None
				fileLinecount = int(subprocess.Popen(('wc', '-l', path), stdout=subprocess.PIPE).stdout.read().strip().split()[0])
			logLinecount += fileLinecount
			# if gzipped:
			# 	_sprint( '"%s", "%s", "%s" -> ' % (path + GzipSuffix, fileBytes, fileLinecount) )
			# else:
			# 	_sprint( '"%s", "%s", "%s" -> ' % (path, fileBytes, fileLinecount) )

			if fileLinecount <= 0:
				# skip logname if empty
				# print 'ERROR: Empty file? "%s"' % path
				continue

			nonemptyNumber += 1
			try:
				if gzipped:
					logfile = gzip.GzipFile(path + GzipSuffix, 'rb')
				else:
					logfile = open(path, 'rb')
			except (OSError, IOError, ), error:
				error = '\n'.join(map(str, error.args))
				if options.flatStruct:
					addFile('files/' + '%s_%d.stderr' % (logname.strip('/').replace('/', '_'), nonemptyNumber, ), len(error), cStringIO.StringIO(error))
				else:
					addFile('files/' + '%s_%d.stderr' % (logname.strip('/'), nonemptyNumber, ), len(error), cStringIO.StringIO(error))
				continue

			# Add file to archive ...
			if options.flatStruct:
				addFile('files/' + '%s_%d' % (logname.strip('/').replace('/', '_'), nonemptyNumber, ), fileBytes, logfile)
				## print 'Added as "%s_%d"' % (logname.strip('/').replace('/', '_'), nonemptyNumber, )
			else:
				addFile('files/' + '%s_%d' % (logname.strip('/'), nonemptyNumber, ), fileBytes, logfile)
				# print 'Added as "%s_%d"' % (logname.strip('/'), nonemptyNumber, )
			logfile.close()

			if not options.fullLogs:
				if logname not in FullLogs and logLinecount > filter(lambda x: logname.startswith(x[0].replace('*', '')), DirectoryList)[0][1]:
					break

		_sprint('.')
	print 'done.'


def atJobs():
	'''
	Generate a list of at-Jobs (usefull for UCS@school)
	'''
	try:
		from univention.lib import atjobs as at
	except ImportError, error:
		error = str(error.message)
		addFile('info/at-jobs' + '.ERROR', len(error), cStringIO.StringIO(error))
		return

	jobs = ''
	try:
		for job in at.list(extended=True):
			jobs += '\n'.join(str(job))
	except OSError, error:
		error = str(error.message)
		addFile('info/at-jobs' + '.ERROR', len(error), cStringIO.StringIO(error))
	addFile('info/at-jobs', len(jobs), cStringIO.StringIO(jobs))


def tryDelete(filename):
	try:
		os.remove(filename)
	except (OSError, IOError, ):
		pass


def gpg(archiveFileName):
	print("Encrypting file..."),
	keyringFileName = tempfile.mkstemp(prefix='univention-support-info-keyring.', suffix='.gpg')[1]
	secringFileName = tempfile.mkstemp(prefix='univention-support-info-secring.', suffix='.gpg')[1]
	trustdbFileName = tempfile.mkstemp(prefix='univention-support-info-trustdb.', suffix='.gpg')[1]
	tryDelete(trustdbFileName)  # HACK: file must not exist for gpg to work
	gpgFileName = archiveFileName + '.gpg'
	gpgBase = ('gpg',
			   '--batch', '--quiet', '--no-tty',
			   '--with-colons', '--utf8-strings',
			   '--no-auto-check-trustdb', '--no-auto-key-locate',
			   '--no-options',
			   '--no-random-seed-file',
			   '--trust-model','always',
			   '--trustdb-name', trustdbFileName,
			   '--secret-keyring', secringFileName,
			   '--no-default-keyring', '--keyring', keyringFileName,
			   )
	gpgImport  = gpgBase + ('--import',
							)
	gpgEncrypt = gpgBase + ('--recipient', fingerprint,
							'--encrypt', archiveFileName,
							)
	# Popen is a function above which injects the Input to the called process as "human" input
	(exitcode, stdout, stderr, ) = Popen(gpgImport, Input=keyData)
	if exitcode:
		print("gpg-import failed with %s" % (exitcode))
		if stdout:
			print("stdout: %s" % repr(stdout))
		if stderr:
			print("stderr: %s" % repr(stderr))
		tryDelete(keyringFileName)
		tryDelete(keyringFileName + '~')
		tryDelete(secringFileName)
		tryDelete(trustdbFileName)
		tryDelete(gpgFileName)
		return
	(exitcode, stdout, stderr, ) = Popen(gpgEncrypt)
	if exitcode:
		print("gpg-encrypt failed with %s" % (exitcode))
		if stdout:
			print("stdout: " % repr(stdout))
		if stderr:
			print("stderr: %s" % repr(stderr))
		tryDelete(keyringFileName)
		tryDelete(keyringFileName + '~')
		tryDelete(secringFileName)
		tryDelete(trustdbFileName)
		tryDelete(gpgFileName)
		return
	tryDelete(keyringFileName)
	tryDelete(keyringFileName + '~')
	tryDelete(secringFileName)
	tryDelete(trustdbFileName)
	os.chmod(gpgFileName, stat.S_IWUSR | stat.S_IRUSR | stat.S_IRGRP | stat.S_IROTH)
	print("done.")
	return gpgFileName


def checkForRoot():
	if os.geteuid() != 0:
		print 'Please run this program as root!'
		sys.exit(3)


def prepareArchive():
	global archiveFileName, archiveFile, archive
	archiveFileName = tempfile.mkstemp(prefix='univention-support-info-%s.' % hostname, suffix='.tar.bz2')[1]
	archiveFile = open(archiveFileName, 'wb')
	archive = tarfile.open(mode='w|bz2', fileobj=archiveFile)


def closeArchive():
	archive.close()
	archiveFile.close()


def prepareEnvironment():
	global env
	env = os.environ.copy()
	env['LC_ALL'] = 'C'
	env['COLUMNS'] = '250'
	env['HOME'] = tempfile.mkdtemp(prefix='univention-support-info_')

	try:
		shutil.copy('/etc/skel/.bashrc', env['HOME'])
		shutil.copy('/etc/skel/.profile', env['HOME'])
		f = open(os.path.join(env['HOME'], '.toprc'), 'w')
		f.write(toprc)
		f.close()
		os.mkdir("%s/.gnupg" % (env['HOME']))
	except (OSError, IOError, ):
		pass


def cleanup():
	shutil.rmtree(env['HOME'], True)


def main(options):
	checkForRoot()
	global archive, env, sambaDomainVersion, usilog
	prepareArchive()
	prepareEnvironment()
	usilog = tempfile.TemporaryFile(prefix='univention-support-info.')

	# USI Version
	addFile('info/usi_version', len(usiVersion), cStringIO.StringIO(usiVersion))
	print("USI Archiver Version \033[1m%s\033[0m\n" % (usiVersion))

	# Check Samba Version
	if executeCommand('samba4-pdc-dn', (_ldapsearchCommand(), '-xLLL', '(&(univentionService=Samba 4)(objectClass=univentionDomainController))', 'dn')):
		sambaDomainVersion = 4
	else:
		sambaDomainVersion = 3

	# Place new calls below this line
	checkMaintenance()
	collectCommandData()
	simpleFiles(options.flatStruct)
	licenseObject()
	templateFiles(options.flatStruct)
	aptPackageList()
	checkTransactionFile()
	atJobs()
	certificateValidities(options.flatStruct)
	univentionSystemInfo()
	if options.fullLogs:
		rotatedLogs(".*", 1000, options)
	else:
		logDepth = 2
		rotatedLogs("((\.log)?(\.[0-%s](\.gz)?)?$)" % (logDepth), 1000, options)
	checkEntryUUID()
	# Place new calls above this line

	# add USI Error Log
	addFile('info/usi_runtime.log', None, usilog)

	closeArchive()
	print("Data collection completed.\n")

	if options.encrypt:
		gpgArchiveFileName = gpg(archiveFileName)
		if gpgArchiveFileName:
			print("The encrypted data can be found here:\n\t%s\n" % (gpgArchiveFileName))
		else:
			print("WARNING: The data could not be encrypted!")
		print
		print("The unencrypted data can be found here:")
	else:
		print("The data can be found here:")
	print("\t%s" % (archiveFileName))
	cleanup()

if __name__ == "__main__":
	parser = optparse.OptionParser()
	parser.add_option('--encrypt', action='store_true', dest='encrypt', default=False, help='encrypt data (can only be decrypted by Univention support)')
	parser.add_option('--full-logs', action='store_true', dest='fullLogs', default=False, help='collect also rotated logfiles')
	parser.add_option('--flat', action='store_true', dest='flatStruct', default=False, help='flatten the directry structure')
	parser.usage = '\n'.join(('%prog [options]',
							  'collect system information',
							  '',
							  "%prog collects information about the system's configuration.",
							  'The information is stored in a temporary tar archive, the path of which is printed to stdout.',
							  ))
	(options, args, ) = parser.parse_args()
	if args:
		parser.print_help()
		sys.exit(0)

	main(options)
